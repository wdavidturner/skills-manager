#!/bin/bash

# Pre-commit hook to ensure all skills are documented correctly in README.md
# Uses Claude Code to validate that documentation accurately reflects each skill
# Only validates skills that are actually changing in the commit

set -e

README="README.md"

# Check if README exists
if [ ! -f "$README" ]; then
    echo "ERROR: README.md not found"
    exit 1
fi

# Get list of staged files
staged_files=$(git diff --cached --name-only)

# Check if README is staged
readme_changed=false
if echo "$staged_files" | grep -q "^README.md$"; then
    readme_changed=true
fi

# Find which skills have staged changes
changed_skills=()
for file in $staged_files; do
    if [[ "$file" =~ ^skills/([^/]+)/ ]]; then
        skill_name="${BASH_REMATCH[1]}"
        # Add to array if not already present
        if [[ ! " ${changed_skills[*]} " =~ " ${skill_name} " ]]; then
            changed_skills+=("$skill_name")
        fi
    fi
done

# Determine what to validate
if [ "$readme_changed" = true ]; then
    echo "README.md changed - validating all skills..."
    # Get all skills
    skills_to_validate=()
    for skill_dir in $(find ./skills -name "SKILL.md" -not -path "./.git/*" 2>/dev/null); do
        skill_path=$(dirname "$skill_dir")
        skill_name=$(basename "$skill_path")
        if [ "$skill_name" != "template" ]; then
            skills_to_validate+=("$skill_name")
        fi
    done
elif [ ${#changed_skills[@]} -gt 0 ]; then
    echo "Validating changed skills: ${changed_skills[*]}"
    skills_to_validate=("${changed_skills[@]}")
else
    echo "No skill changes detected, skipping validation"
    exit 0
fi

# Check if there are any skills to validate
if [ ${#skills_to_validate[@]} -eq 0 ]; then
    echo "No skills found to validate"
    exit 0
fi

# Check if claude CLI is available
if ! command -v claude &> /dev/null; then
    echo "WARNING: claude CLI not found, falling back to basic name check..."

    # Fallback: basic check that skill names appear in README
    missing_skills=()
    for skill_name in "${skills_to_validate[@]}"; do
        if ! grep -q "$skill_name" "$README"; then
            missing_skills+=("$skill_name")
        fi
    done

    if [ ${#missing_skills[@]} -gt 0 ]; then
        echo "ERROR: The following skills are not documented in README.md:"
        for skill in "${missing_skills[@]}"; do
            echo "  - $skill"
        done
        exit 1
    fi
    echo "Basic check passed: All skill names found in README.md"
    exit 0
fi

# Validate with Claude
validation_failed=0
failed_skills=()

for skill_name in "${skills_to_validate[@]}"; do
    skill_file="./skills/$skill_name/SKILL.md"

    if [ ! -f "$skill_file" ]; then
        echo "  ⚠ Skipping $skill_name: SKILL.md not found"
        continue
    fi

    echo "  Checking: $skill_name"

    # Call Claude in non-interactive mode to validate
    result=$(claude -p "Validate that the skill at '$skill_file' is accurately documented in README.md. Read both files and check that the README's description in the 'Our Skills' section correctly reflects what the skill does. Output only 'VALID' if correct, or 'INVALID: <reason>' if not." 2>&1) || true

    if [[ "$result" == VALID* ]]; then
        echo "    ✓ Valid"
    else
        echo "    ✗ $result"
        validation_failed=1
        failed_skills+=("$skill_name: $result")
    fi
done

if [ $validation_failed -eq 1 ]; then
    echo ""
    echo "ERROR: Skill documentation validation failed:"
    for failure in "${failed_skills[@]}"; do
        echo "  - $failure"
    done
    echo ""
    echo "Please update README.md to accurately document these skills."
    exit 1
fi

echo "All validated skills are correctly documented in README.md"

# Regenerate skills-data.json if skills changed
if [ ${#changed_skills[@]} -gt 0 ] || [ "$readme_changed" = true ]; then
    if [ -f "site/package.json" ]; then
        echo ""
        echo "Regenerating skills-data.json..."
        cd site
        if npm run build:skills 2>/dev/null; then
            cd ..
            # Stage the updated skills-data.json if it changed
            if git diff --quiet site/src/skills-data.json 2>/dev/null; then
                echo "  No changes to skills-data.json"
            else
                git add site/src/skills-data.json
                echo "  ✓ Updated and staged skills-data.json"
            fi
        else
            cd ..
            echo "  ⚠ Failed to regenerate skills-data.json (npm dependencies may not be installed)"
        fi
    fi
fi

exit 0
